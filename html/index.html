<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>–¢–µ–ø—ñ–Ω–≥-—Ç–µ—Å—Ç –Ü–ª—å—ó–Ω–∞ (30 —Å, 6√ó5 —Å)</title>
<style>
  :root{
    --bg:#f7f8fb; --fg:#111; --muted:#62646a; --card:#fff; --accent:#2b6ef6; --ok:#16a34a; --warn:#ef4444;
    --gap:10px;
  }
  html{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--fg); min-height:100vh; overflow-x:hidden;}
  .wrap{
    width:100%; max-width:820px; margin:0 auto; padding:10px;
    display:flex; flex-direction:column; gap:8px; min-height:100vh; box-sizing:border-box;
  }
  h1{font-size:1.05rem; margin:0}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .card{background:var(--card); border-radius:12px; padding:10px; box-shadow:0 1px 2px rgba(0,0,0,.06)}
  label{font-size:.85rem; color:var(--muted); display:block; margin-bottom:3px}
  input,select{width:100%; padding:10px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; font-size:1rem; box-sizing:border-box; appearance:none}
  select{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e"); background-position:right 10px center; background-repeat:no-repeat; background-size:16px; padding-right:40px}
  input:focus,select:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(43,110,246,0.1)}
  .input-group{position:relative; display:block}
  .input-group input{width:100%; padding-right:45px}
  .copy-btn{position:absolute; right:8px; top:50%; transform:translateY(-50%); background:#f3f4f6; border:0; color:#6b7280; cursor:pointer; font-size:0.8rem; padding:4px 8px; border-radius:6px; transition:all 0.2s; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none}
  .input-group:focus-within .copy-btn{opacity:1; pointer-events:auto}
  .copy-btn:hover{background:#e5e7eb; color:#374151}
  .copy-btn:active{background:#d1d5db}
  .copy-btn.copied{color:#16a34a; background:#dcfce7}
  button{padding:12px 16px; border:0; border-radius:12px; font-size:1.05rem; cursor:pointer}
  .primary{background:#16a34a; color:#fff} /* Changed to green */
  .primary:hover{background:#15803d}
  .primary:active{background:#166534}
  .secondary{background:#eef2ff; color:#1f2937}
  .danger{background:#ffe4e6; color:#991b1b}
  .timer{font-size:1.5rem; font-weight:700}
  .small{font-size:.9rem; color:#444}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.9rem}
  .hdr{display:grid; grid-template-columns:1fr auto; align-items:center}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; font-size:.75rem; color:#374151}
  .startbar{display:flex; justify-content:center; gap:8px; align-items:center;}
  .startbar .primary{min-width:180px}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); grid-auto-rows: minmax(90px, 16.5vh); gap:var(--gap);}
  .cell{border-radius:14px; background:linear-gradient(180deg,#fff,#f9fbff); border:2px dashed #cbd5ff;
    display:flex; align-items:center; justify-content:center; user-select:none; touch-action:manipulation; position:relative;}
  .cell:not(.active) {touch-action: auto;}
  .cell .cnt{font-size:1.35rem; color:#374151}
  .cell.active{ border:3px solid var(--accent); box-shadow:0 0 0 4px rgba(43,110,246,.12) }
  .cell.active::after{content:"–ê–∫—Ç–∏–≤–Ω–æ"; position:absolute; top:6px; right:8px; font-size:.72rem; color:#1e40af; background:#eef2ff; padding:2px 8px; border-radius:999px;}
  .stats{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .muted{color:var(--muted)}
  /* Removed details/summary styles - results always visible now */
  .tbl{width:100%; border-collapse:collapse}
  .tbl th,.tbl td{border-bottom:1px solid #eee; padding:6px 8px; font-size:.9rem; vertical-align:top}
  
  /* Mobile test mode - hide everything except tapping areas and stop button */
  @media (max-width: 768px) {
    body.test-mode .wrap > *:not(.grid):not(.mobile-controls) { display: none !important; }
    body.test-mode .wrap { padding: 5px; gap: 10px; justify-content: center; }
    body.test-mode .grid { flex: 1; max-height: calc(100vh - 80px); }
    body.test-mode .mobile-controls { 
      position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); 
      z-index: 1000; display: flex; gap: 10px; align-items: center;
      background: rgba(255,255,255,0.95); padding: 10px 20px; border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    body.test-mode .mobile-timer { font-size: 1.2rem; font-weight: 600; color: var(--accent); }
  }
  
  /* Countdown overlay */
  .countdown-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.8); z-index: 2000;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(2px);
  }
  .countdown-number {
    font-size: 8rem; font-weight: 900; color: #fff;
    text-shadow: 0 4px 20px rgba(0,0,0,0.5);
    animation: countdownPulse 1s ease-in-out;
  }
  @keyframes countdownPulse {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
  }
  @media (max-width: 768px) {
    .countdown-number { font-size: 6rem; }
  }
  
  /* Responsive table for mobile */
  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  @media (max-width: 768px) {
    .table-container {
      margin: 0 -10px;
      padding: 0 10px;
    }
    .tbl {
      min-width: 600px;
      font-size: 0.8rem;
    }
    .tbl th, .tbl td {
      padding: 4px 6px;
      white-space: nowrap;
    }
    .intervals-col {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }
  
  /* Delete button styling */
  .delete-btn {
    background: transparent;
    border: none;
    color: #ef4444;
    cursor: pointer;
    font-size: 1rem;
    padding: 2px 4px;
    border-radius: 4px;
    transition: all 0.2s;
  }
  .delete-btn:hover {
    background: #fef2f2;
    color: #dc2626;
  }
  
  /* Mobile button layout fixes */
  @media (max-width: 768px) {
    /* Only apply to action buttons row, not form row */
    .action-buttons.row {
      flex-direction: column;
      gap: 8px;
    }
    .action-buttons button {
      width: 100%;
      text-align: center;
      font-size: 1rem;
      padding: 14px 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Stack buttons vertically on mobile for better touch targets */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    /* Fix form layout on mobile */
    .card .row:not(.action-buttons) {
      flex-direction: column;
      align-items: stretch !important;
      gap: 12px;
    }
    .card .row:not(.action-buttons) > div {
      min-width: auto;
      width: 100%;
    }
    /* Ensure input-group works properly on mobile */
    .input-group {
      width: 100%;
    }
    .action-buttons button {
      min-height: 48px; /* Better touch target */
    }
    /* Fix counter width on mobile to prevent jumping */
    .cell .cnt {
      min-width: 2ch;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }
    @media (max-width: 480px) {
      .cell .cnt {
        min-width: 3ch;
        font-size: 1.5rem;
      }
    }
    /* Enhanced start button for mobile */
    .startbar {
      flex-direction: column;
      padding: 16px 0;
    }
    .startbar .primary {
      font-size: 1.2rem;
      font-weight: 600;
      padding: 16px 32px;
      min-height: 56px;
      width: 100%;
      max-width: 280px;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
      border-radius: 16px;
    }
    .startbar .primary:hover {
      box-shadow: 0 6px 16px rgba(22, 163, 74, 0.4);
      transform: translateY(-1px);
    }
  }
  
  /* QR Code styles - only show on desktop */
  .qr-mobile-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    position: relative;
    overflow: visible;
    padding: 16px 10px;
  }
  .qr-mobile-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    pointer-events: none;
  }
  .qr-content {
    display: flex;
    align-items: center;
    gap: 16px;
    position: relative;
    z-index: 1;
    min-height: 140px;
    padding: 8px 0;
  }
  .qr-info {
    flex: 1;
  }
  .qr-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 4px 0;
    color: white;
  }
  .qr-subtitle {
    font-size: 0.9rem;
    opacity: 0.9;
    margin: 0;
  }
  .qr-code-container {
    background: white;
    padding: 12px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .qr-code-container img {
    display: block;
    width: 120px;
    height: 120px;
  }
  
  /* Hide QR code on mobile devices */
  @media (max-width: 768px) {
    .qr-mobile-card {
      display: none !important;
    }
  }
  
  /* Psychological Feedback Styles */
  .feedback-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    position: relative;
    overflow: visible;
    margin-top: 8px;
    padding: 20px 10px;
    min-height: auto;
    animation: slideInUp 0.5s ease-out;
  }
  
  .feedback-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at top right, rgba(255,255,255,0.1) 0%, transparent 70%);
    pointer-events: none;
    border-radius: 12px;
  }
  
  .feedback-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    position: relative;
    z-index: 1;
  }
  
  .feedback-icon {
    font-size: 2rem;
    animation: pulse 2s infinite;
  }
  
  .feedback-header h3 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
  }
  
  .feedback-content {
    position: relative;
    z-index: 1;
    line-height: 1.6;
  }
  
  .feedback-metric {
    background: rgba(255,255,255,0.15);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 12px;
    backdrop-filter: blur(10px);
  }
  
  .feedback-metric strong {
    display: block;
    font-size: 1.8rem;
    margin-bottom: 4px;
  }
  
  .feedback-metric .label {
    font-size: 0.9rem;
    opacity: 0.95;
  }
  
  .feedback-interpretation {
    background: rgba(255,255,255,0.1);
    border-left: 4px solid rgba(255,255,255,0.5);
    padding: 12px;
    border-radius: 8px;
    margin: 16px 0;
  }
  
  .feedback-interpretation p {
    margin: 8px 0;
  }
  
  .feedback-interpretation p:first-child {
    margin-top: 0;
  }
  
  .feedback-interpretation p:last-child {
    margin-bottom: 0;
  }
  
  .feedback-note {
    font-size: 0.85rem;
    opacity: 0.9;
    font-style: italic;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(255,255,255,0.2);
  }
  
  @keyframes slideInUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.1);
    }
  }
  
  /* Fix mobile scrolling issues */
  @media (max-width: 768px) {
    body {
      -webkit-overflow-scrolling: touch;
      overflow-y: auto;
      touch-action: pan-y;
    }
    .wrap {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .feedback-card {
      margin-top: 8px;
      padding: 16px 10px;
    }
    .feedback-icon {
      font-size: 1.5rem;
    }
    .feedback-header h3 {
      font-size: 1.1rem;
    }
    .feedback-metric strong {
      font-size: 1.5rem;
    }
  }
</style>
</head>
<body>
<div class="wrap">

  <div class="card hdr">
    <h1>–¢–µ–ø—ñ–Ω–≥-—Ç–µ—Å—Ç –Ü–ª—å—ó–Ω–∞ (30 —Å, 6 —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ–≤ √ó 5 —Å)</h1>
    <span class="pill">–ü—Ä–æ—Ç–æ–∫–æ–ª: 30 —Å ¬∑ –∫—Ä–æ–∫ 5 —Å ¬∑ 6 –∫–≤–∞–¥—Ä–∞—Ç—ñ–≤</span>
  </div>

  <!-- QR Code for Mobile Access - Desktop Only -->
  <div class="card qr-mobile-card">
    <div class="qr-content">
      <div class="qr-info">
        <h3 class="qr-title">üì± –û–±–æ–≤'—è–∑–∫–æ–≤–æ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É!</h3>
        <p class="qr-subtitle">–¢–µ—Å—Ç –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –ø—Ä–æ–≤–æ–¥–∏—Ç–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—ñ –¥–ª—è —Ç–æ—á–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤. –í—ñ–¥—Å–∫–∞–Ω—É–π—Ç–µ QR-–∫–æ–¥.</p>
      </div>
      <div class="qr-code-container">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https%3A//yoctoalex.github.io/tapping-test/" alt="QR –∫–æ–¥ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó" />
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items:end;">
      <div style="flex:1; min-width:160px;">
        <label>–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä —É—á–∞—Å–Ω–∏–∫–∞</label>
        <div class="input-group">
          <input id="pid" placeholder="–ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ" readonly />
          <button type="button" class="copy-btn" id="copyBtn">copy</button>
        </div>
      </div>
      <div style="min-width:150px;">
        <label>–†—É–∫–∞</label>
        <select id="hand">
          <option value="right">–ø—Ä–∞–≤–∞</option>
          <option value="left">–ª—ñ–≤–∞</option>
        </select>
      </div>
      <div style="min-width:120px;">
        <label>–ü—Ä–æ–±–∞</label>
        <select id="trial"><option>1</option><option>2</option><option>3</option></select>
      </div>
      <div style="min-width:140px;">
        <label>–¢–∞–π–º–µ—Ä</label>
        <div class="timer" id="timer">30.0 —Å</div>
      </div>
    </div>
    <div class="startbar" style="margin-top:6px;">
      <button class="primary" id="startBtn">–°—Ç–∞—Ä—Ç</button>
    </div>
    <div class="small" style="margin-top:4px;">–¢–∏—Å–Ω–∏ —è–∫–æ–º–æ–≥–∞ —à–≤–∏–¥—à–µ –≤ <strong>–ø—ñ–¥—Å–≤—ñ—á–µ–Ω–∏–π</strong> –∫–≤–∞–¥—Ä–∞—Ç. –û–¥–∏–Ω –ø–∞–ª–µ—Ü—å.</div>
  </div>

  <div class="grid" id="grid">
    <div class="cell" data-idx="0"><div class="cnt" id="c0">0</div></div>
    <div class="cell" data-idx="1"><div class="cnt" id="c1">0</div></div>
    <div class="cell" data-idx="2"><div class="cnt" id="c2">0</div></div>
    <div class="cell" data-idx="3"><div class="cnt" id="c3">0</div></div>
    <div class="cell" data-idx="4"><div class="cnt" id="c4">0</div></div>
    <div class="cell" data-idx="5"><div class="cnt" id="c5">0</div></div>
  </div>

  <!-- Mobile controls shown during test -->
  <div class="mobile-controls" id="mobileControls" style="display:none;">
    <div class="mobile-timer" id="mobileTimer">30.0 —Å</div>
    <button class="primary" id="mobileStopBtn">–°—Ç–æ–ø</button>
  </div>

  <!-- Countdown overlay -->
  <div class="countdown-overlay" id="countdownOverlay" style="display:none;">
    <div class="countdown-number" id="countdownNumber">3</div>
  </div>

  <!-- Psychological Feedback Card - shown after test completion -->
  <div class="card feedback-card" id="feedbackCard" style="display:none;">
    <div class="feedback-header">
      <span class="feedback-icon">üß†</span>
      <h3>–í–∞—à –ø—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å</h3>
    </div>
    <div class="feedback-content" id="feedbackContent">
      <!-- Dynamic content will be inserted here -->
    </div>
  </div>

  <div class="card stats">
    <div>
      –í—Å—å–æ–≥–æ –Ω–∞—Ç–∏—Å–∫–∞–Ω—å: <strong id="total">0</strong><br/>
      –Ü–Ω–¥–µ–∫—Å —Å—Ç–æ–º–ª—é–≤–∞–Ω–æ—Å—Ç—ñ: <span id="fatigue" class="mono">‚Äî</span>
    </div>
    <div>
      <div><strong>–Ü–Ω—Ç–µ—Ä–≤–∞–ª–∏ (–ø–æ 5 —Å):</strong></div>
      <div id="intervals" class="mono small muted">‚Äî –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö ‚Äî</div>
    </div>
  </div>

  <div class="card small">
    <strong>–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è:</strong> 30 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ø—ñ–ª—å —à–≤–∏–¥–∫–æ —Ç–æ—Ä–∫–∞–π—Å—è –ø—ñ–¥—Å–≤—ñ—á–µ–Ω–æ–≥–æ –∫–≤–∞–¥—Ä–∞—Ç–∞.
    –ö–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥ –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∑–∞ —Å—Ö–µ–º–æ—é ¬´–ü¬ª: <em>–∑–Ω–∏–∑—É –≤–≥–æ—Ä—É –ª—ñ–≤–∏–π —Å—Ç–æ–≤–ø–µ—Ü—å ‚Üí –∑–≤–µ—Ä—Ö—É –≤–ø—Ä–∞–≤–æ</em>.
  </div>

  <div class="card small">
    <div class="row action-buttons" style="gap:6px; flex-wrap:wrap;">
      <button id="copyLatestBtn" class="primary" disabled>–ö–æ–ø—ñ—é–≤–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
      <button id="showLatestBtn" class="secondary" disabled>–í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
      <button id="exportBtn" class="secondary">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—ñ —è–∫ CSV</button>
      <button id="clearBtn" class="danger">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ</button>
    </div>
    <div style="margin-top:12px;">
      <div style="margin-bottom:8px; font-weight:600; color:var(--fg);">–ó–±–µ—Ä–µ–∂–µ–Ω—ñ —Å–ø—Ä–æ–±–∏</div>
      <div class="table-container">
        <table class="tbl">
          <thead><tr><th>PID</th><th>—Ä—É–∫–∞</th><th>–ø—Ä–æ–±–∞</th><th>—É—Å—å–æ–≥–æ</th><th class="intervals-col">—ñ–Ω—Ç–µ—Ä–≤–∞–ª–∏</th><th>F, %</th><th>–¥–∞—Ç–∞</th><th></th></tr></thead>
          <tbody id="runsBody"><tr><td colspan="8" class="small muted">–©–µ –Ω–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö —Å–ø—Ä–æ–±</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
(() => {
  const TOTAL_S = 30, STEP_S = 5, N = TOTAL_S / STEP_S;
  const ORDER = [4,2,0,1,3,5]; // —Å—Ö–µ–º–∞ "–ü"
  const pidEl=document.getElementById('pid'), handEl=document.getElementById('hand'), trialEl=document.getElementById('trial');
  
  // Auto-generate and manage user ID
  function generateUserId() {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substr(2, 4);
    return `P${timestamp}${random}`.toUpperCase();
  }
  
  function loadOrGenerateUserId() {
    let userId = localStorage.getItem('tapping_user_id');
    if (!userId) {
      userId = generateUserId();
      localStorage.setItem('tapping_user_id', userId);
    }
    return userId;
  }
  
  // Save and load current test state
  function saveCurrentState() {
    const state = {
      counts: counts.slice(),
      tapsTimestamps: tapsTimestamps.slice(),
      started: started,
      startAt: startAt,
      activeIdx: activeIdx,
      hand: handEl.value,
      trial: +trialEl.value,
      timestamp: Date.now()
    };
    localStorage.setItem('tapping_current_state', JSON.stringify(state));
  }
  
  function loadPreviousState() {
    const stateStr = localStorage.getItem('tapping_current_state');
    if (!stateStr) return false;
    
    try {
      const state = JSON.parse(stateStr);
      // Check if state is recent (within last 24 hours)
      if (Date.now() - state.timestamp > 24 * 60 * 60 * 1000) {
        localStorage.removeItem('tapping_current_state');
        return false;
      }
      
      counts = state.counts || Array.from({length:N},()=>0);
      tapsTimestamps = state.tapsTimestamps || [];
      handEl.value = state.hand || 'right';
      trialEl.value = state.trial || 1;
      
      // Update UI
      updateUIFromState();
      
      const total = counts.reduce((a,b)=>a+b,0);
      if (total > 0) {
        copyLatestBtn.disabled = false;
      }
      // Also check if there are any saved results to enable copy button
      const arr = JSON.parse(localStorage.getItem('tapping_runs_iljin_v1') || '[]');
      if (arr.length > 0) {
        copyLatestBtn.disabled = false;
      }
      
      return true;
    } catch (e) {
      localStorage.removeItem('tapping_current_state');
      return false;
    }
  }
  
  function updateUIFromState() {
    // Update counters display
    counts.forEach((count, i) => {
      document.getElementById('c' + ORDER[i]).textContent = count;
    });
    
    // Update total
    const total = counts.reduce((a,b)=>a+b,0);
    totalEl.textContent = total;
    
    // Update intervals and fatigue
    renderIntervals();
  }
  
  function clearCurrentState() {
    localStorage.removeItem('tapping_current_state');
  }
  
  // Mobile test mode functions
  function isMobile() {
    return window.innerWidth <= 768;
  }
  
  function enterMobileTestMode() {
    if (isMobile()) {
      document.body.classList.add('test-mode');
      document.getElementById('mobileControls').style.display = 'flex';
      // Prevent scrolling during test
      document.body.style.overflow = 'hidden';
    }
  }
  
  function exitMobileTestMode() {
    document.body.classList.remove('test-mode');
    document.getElementById('mobileControls').style.display = 'none';
    document.body.style.overflow = '';
    // Ensure mobile timer is also reset
    const mobileTimer = document.getElementById('mobileTimer');
    if (mobileTimer) {
      mobileTimer.textContent = '30.0 —Å';
    }
  }
  
  function updateMobileTimer() {
    if (isMobile()) {
      const mobileTimer = document.getElementById('mobileTimer');
      if (mobileTimer) {
        mobileTimer.textContent = timerEl.textContent;
      }
    }
  }
  
  // Countdown functionality
  function showCountdown(callback) {
    const overlay = document.getElementById('countdownOverlay');
    const numberEl = document.getElementById('countdownNumber');
    let count = 3;
    
    overlay.style.display = 'flex';
    
    function updateCountdown() {
      if (count > 0) {
        numberEl.textContent = count;
        // Trigger animation by removing and adding class
        numberEl.style.animation = 'none';
        numberEl.offsetHeight; // Trigger reflow
        numberEl.style.animation = 'countdownPulse 1s ease-in-out';
        count--;
        setTimeout(updateCountdown, 1000);
      } else {
        overlay.style.display = 'none';
        callback();
      }
    }
    
    updateCountdown();
  }
  
  // Copy latest result functionality
  async function copyLatestResult() {
    const arr = JSON.parse(localStorage.getItem('tapping_runs_iljin_v1') || '[]');
    if (arr.length === 0) {
      alert('–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤');
      return;
    }
    
    const latest = arr[arr.length - 1];
    const resultText = `–¢–µ–ø—ñ–Ω–≥-—Ç–µ—Å—Ç –Ü–ª—å—ó–Ω–∞ - –†–µ–∑—É–ª—å—Ç–∞—Ç
` +
      `ID: ${latest.pid}\n` +
      `–†—É–∫–∞: ${latest.hand === 'right' ? '–ø—Ä–∞–≤–∞' : '–ª—ñ–≤–∞'}\n` +
      `–ü—Ä–æ–±–∞: ${latest.trial}\n` +
      `–£—Å—å–æ–≥–æ –Ω–∞—Ç–∏—Å–∫–∞–Ω—å: ${latest.total}\n` +
      `–Ü–Ω–¥–µ–∫—Å —Å—Ç–æ–º–ª—é–≤–∞–Ω–æ—Å—Ç—ñ: ${(latest.F >= 0 ? '+' : '')}${latest.F}%\n` +
      `–Ü–Ω—Ç–µ—Ä–≤–∞–ª–∏ (${latest.step}—Å): ${latest.counts.join(', ')}\n` +
      `–î–∞—Ç–∞: ${new Date(latest.ts).toLocaleString()}`;
    
    try {
      await navigator.clipboard.writeText(resultText);
      showCopyFeedback();
    } catch (err) {
      // Fallback for older browsers
      const textarea = document.createElement('textarea');
      textarea.value = resultText;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      showCopyFeedback();
    }
  }
  
  function showCopyFeedback() {
    const feedback = document.createElement('div');
    feedback.textContent = 'Result copied to clipboard ‚úì';
    feedback.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 3000;
      background: #dcfce7; color: #166534; padding: 12px 20px;
      border-radius: 10px; font-size: 0.9rem; font-weight: 600;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      animation: slideInRight 0.3s ease-out;
    `;
    
    document.body.appendChild(feedback);
    setTimeout(() => {
      feedback.style.animation = 'slideOutRight 0.3s ease-in';
      setTimeout(() => feedback.remove(), 300);
    }, 2500);
  }
  

  
    // Auto-save functionality
  function autoSave() {
    const total=counts.reduce((a,b)=>a+b,0);
    if(total===0){saveBtn.disabled=false;return;}
    
    const fatigueIdx = fatigueIndex(counts);
    const run={pid:pidEl.value.trim(),hand:handEl.value,trial:+trialEl.value,duration:TOTAL_S,step:STEP_S,counts:counts.slice(),total,F:+fatigueIdx.toFixed(1),
      times:tapsTimestamps.slice(),device:navigator.userAgent,ts:new Date().toISOString()};
    const KEY='tapping_runs_iljin_v1';const arr=JSON.parse(localStorage.getItem(KEY)||'[]');arr.push(run);localStorage.setItem(KEY,JSON.stringify(arr));
    renderRuns();copyLatestBtn.disabled=false;showLatestBtn.disabled=false;clearCurrentState();
    
    // Generate psychological feedback
    generatePsychologicalFeedback(counts, total, fatigueIdx);
    
    // Show auto-save feedback
    showAutoSaveFeedback();
  }

  // Psychological Feedback Generator
  function generatePsychologicalFeedback(counts, total, fatigueIdx) {
    const feedbackCard = document.getElementById('feedbackCard');
    const feedbackContent = document.getElementById('feedbackContent');
    
    // Calculate extended metrics for deeper analysis
    const firstHalf = counts.slice(0, 3).reduce((a, b) => a + b, 0);
    const secondHalf = counts.slice(3).reduce((a, b) => a + b, 0);
    const avgTaps = total / counts.length;
    const maxTaps = Math.max(...counts);
    const minTaps = Math.min(...counts);
    const variation = maxTaps - minTaps;
    const variationPercent = (variation / avgTaps * 100).toFixed(0);
    
    // New metrics for deeper analysis
    const firstInterval = counts[0];
    const lastInterval = counts[counts.length - 1];
    const middleIntervals = counts.slice(1, -1).reduce((a, b) => a + b, 0) / (counts.length - 2);
    
    // Calculate tempo stability (standard deviation)
    const mean = total / counts.length;
    const variance = counts.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / counts.length;
    const stdDev = Math.sqrt(variance);
    const stabilityCoef = (stdDev / mean * 100).toFixed(0);
    
    // Peak performance analysis
    const peakIndex = counts.indexOf(maxTaps);
    const peakTiming = peakIndex < 2 ? '–ø–æ—á–∞—Ç–æ–∫' : peakIndex < 4 ? '—Å–µ—Ä–µ–¥–∏–Ω–∞' : '–∫—ñ–Ω–µ—Ü—å';
    
    // Recovery analysis (if there's a dip and recovery)
    let hasRecovery = false;
    for (let i = 1; i < counts.length - 1; i++) {
      if (counts[i] < counts[i-1] && counts[i+1] > counts[i]) {
        hasRecovery = true;
        break;
      }
    }
    
    // Momentum analysis
    const momentum = ((lastInterval - firstInterval) / firstInterval * 100).toFixed(0);
    
    // Determine profile type based on pattern
    let profileType = '';
    let strategyText = '';
    let attentionText = '';
    let enduranceText = '';
    let rhythmText = '';
    let peakText = '';
    let recoveryText = '';
    
    // Profile analysis with extended criteria
    if (fatigueIdx < -10) {
      profileType = '–ü—Ä–æ–≥—Ä–µ—Å–∏–≤–Ω–∏–π';
      strategyText = '–í–∏ —Å—Ç–∞—Ä—Ç—É—î—Ç–µ –æ–±–µ—Ä–µ–∂–Ω–æ, –∞ –ø–æ—Ç—ñ–º ¬´—Ä–æ–∑—ñ–≥—Ä—ñ–≤–∞—î—Ç–µ—Å—å¬ª —ñ –≤—Ö–æ–¥–∏—Ç–µ –≤ —Ä–∏—Ç–º. –¶–µ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è ¬´–º–∞—Ä–∞—Ñ–æ–Ω—Ü—è¬ª ‚Äî –≤–∏ –≤–º—ñ—î—Ç–µ —Ä–æ–∑–ø–æ–¥—ñ–ª—è—Ç–∏ —Å–∏–ª–∏ —Ç–∞ –Ω–∞—Ä–æ—â—É–≤–∞—Ç–∏ —Ç–µ–º–ø –ø–æ—Å—Ç—É–ø–æ–≤–æ.';
      attentionText = '–í–∞—à–∞ —É–≤–∞–≥–∞ –ø–æ–∫—Ä–∞—â—É—î—Ç—å—Å—è –∑ —á–∞—Å–æ–º ‚Äî –≤–∏ –ø–æ—Ç—Ä–µ–±—É—î—Ç–µ —Ç—Ä–æ—Ö–∏ —á–∞—Å—É –¥–ª—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—ó, –∞–ª–µ –ø–æ—Ç—ñ–º –ø–æ–∫–∞–∑—É—î—Ç–µ —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.';
    } else if (fatigueIdx > 15) {
      profileType = '–°–ø—Ä–∏–Ω—Ç–µ—Ä—Å—å–∫–∏–π';
      strategyText = '–í–∏ —Å—Ç–∞—Ä—Ç—É—î—Ç–µ —à–≤–∏–¥–∫–æ –π –ø–æ—Ç—É–∂–Ω–æ, –≤–∏–∫–ª–∞–¥–∞—é—á–∏—Å—å –æ–¥—Ä–∞–∑—É. –¶–µ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è ¬´—Å–ø—Ä–∏–Ω—Ç–µ—Ä–∞¬ª ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –º–æ–±—ñ–ª—ñ–∑–∞—Ü—ñ—è –Ω–∞ –ø–æ—á–∞—Ç–∫—É –∑ –ø—Ä–∏—Ä–æ–¥–Ω–∏–º —Å–ø–∞–¥–æ–º –Ω–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ.';
      attentionText = '–í–∏ —à–≤–∏–¥–∫–æ –≤–∫–ª—é—á–∞—î—Ç–µ—Å—å —É —Ä–æ–±–æ—Ç—É, –∞–ª–µ —É–≤–∞–≥–∞ –≤—Ç–æ–º–ª—é—î—Ç—å—Å—è –Ω–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ. –¶–µ –ø—Ä–∏—Ä–æ–¥–Ω–æ –π —Ç–∏–ø–æ–≤–æ –¥–ª—è –ª—é–¥–µ–π –∑ –≤–∏—Å–æ–∫–æ—é –ø–æ—á–∞—Ç–∫–æ–≤–æ—é –º–æ–±—ñ–ª—ñ–∑–∞—Ü—ñ—î—é.';
    } else if (stabilityCoef < 15) {
      profileType = '–°—Ç–∞–±—ñ–ª—å–Ω–∏–π';
      strategyText = '–í–∞—à —Ç–µ–º–ø –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —Ä—ñ–≤–Ω–∏–º —É–ø—Ä–æ–¥–æ–≤–∂ —É—Å—å–æ–≥–æ —Ç–µ—Å—Ç—É ‚Äî —Ü–µ –æ–∑–Ω–∞–∫–∞ –≤–º—ñ–Ω–Ω—è —Ç—Ä–∏–º–∞—Ç–∏ –±–∞–ª–∞–Ω—Å —ñ —Ä–æ–∑–ø–æ–¥—ñ–ª—è—Ç–∏ —Å–∏–ª–∏. –í–∏ –¥–æ–±—Ä–µ –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç–µ —Å–≤—ñ–π —Ä–∏—Ç–º.';
      attentionText = '–í–∞—à–∞ —É–≤–∞–≥–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—é –ø—Ä–æ—Ç—è–≥–æ–º —É—Å—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è. –í–∏ –∑–¥–∞—Ç–Ω—ñ —É—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—é —Ç–∞ –Ω–µ –ø—ñ–¥–¥–∞–≤–∞—Ç–∏—Å—å –≤—Ç–æ–º—ñ üßò.';
    } else {
      profileType = '–ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π';
      strategyText = '–í–∞—à —Ç–µ–º–ø –∑–º—ñ–Ω—é—î—Ç—å—Å—è –ø—Ä–æ—Ç—è–≥–æ–º —Ç–µ—Å—Ç—É ‚Äî –≤–∏ –∞–¥–∞–ø—Ç—É—î—Ç–µ—Å—å –¥–æ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞ —à—É–∫–∞—î—Ç–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏–π —Ä–∏—Ç–º. –¶–µ –≥–Ω—É—á–∫–∏–π –ø—ñ–¥—Ö—ñ–¥ –¥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.';
      attentionText = '–í–∞—à–∞ —É–≤–∞–≥–∞ –º–∞—î —Ö–≤–∏–ª—å–æ–≤–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä ‚Äî –ø–µ—Ä—ñ–æ–¥–∏ –≤–∏—Å–æ–∫–æ—ó –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—ó —á–µ—Ä–≥—É—é—Ç—å—Å—è –∑ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Å–ø–∞–¥–∞–º–∏. –¶–µ –Ω–æ—Ä–º–∞–ª—å–Ω–∞ –¥–∏–Ω–∞–º—ñ–∫–∞ —Ä–æ–±–æ—Ç–∏ –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏.';
    }
    
    // Endurance analysis with more detail
    if (total > 250) {
      enduranceText = `–í–∏—Å–æ–∫–∏–π –∑–∞–≥–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (${total} –Ω–∞—Ç–∏—Å–∫–∞–Ω—å) —Å–≤—ñ–¥—á–∏—Ç—å –ø—Ä–æ –≤—ñ–¥–º—ñ–Ω–Ω—É –ø—Å–∏—Ö–æ–º–æ—Ç–æ—Ä–Ω—É –≤–∏—Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Ç–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å —Ä–µ–∞–∫—Ü—ñ—ó. –í–∞—à–∞ –Ω–µ—Ä–≤–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞—Ü—é—î –Ω–∞ –≤–∏—Å–æ–∫—ñ–π —á–∞—Å—Ç–æ—Ç—ñ.`;
    } else if (total > 200) {
      enduranceText = `–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (${total} –Ω–∞—Ç–∏—Å–∫–∞–Ω—å) –ø–æ–∫–∞–∑—É—î –∑–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω—É —Ä–æ–±–æ—Ç—É –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ –¥–æ—Å—Ç–∞—Ç–Ω—é –≤–∏—Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å. –í–∏ –º–∞—î—Ç–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å —à–≤–∏–¥–∫–æ—Å—Ç—ñ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é.`;
    } else if (total > 150) {
      enduranceText = `–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç (${total} –Ω–∞—Ç–∏—Å–∫–∞–Ω—å) –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î —Å–ø–æ–∫—ñ–π–Ω–∏–π, —Ä–æ–∑–º—ñ—Ä–µ–Ω–∏–π —Å—Ç–∏–ª—å —Ä–æ–±–æ—Ç–∏. –í–∏ –Ω–µ –ø–æ—Å–ø—ñ—à–∞—î—Ç–µ, –∞–ª–µ –≤–∏–∫–æ–Ω—É—î—Ç–µ –∑–∞–≤–¥–∞–Ω–Ω—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ —Ç–∞ —É—Å–≤—ñ–¥–æ–º–ª–µ–Ω–æ.`;
    } else {
      enduranceText = `–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç (${total} –Ω–∞—Ç–∏—Å–∫–∞–Ω—å) –º–æ–∂–µ —Å–≤—ñ–¥—á–∏—Ç–∏ –ø—Ä–æ –æ–±–µ—Ä–µ–∂–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –∞–±–æ –≤—Ç–æ–º—É. –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Ç–µ—Å—Ç –ø—ñ—Å–ª—è –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è.`;
    }
    
    // Rhythm analysis
    if (stabilityCoef < 10) {
      rhythmText = `–í–∞—à —Ä–∏—Ç–º –Ω–∞–¥–∑–≤–∏—á–∞–π–Ω–æ —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π (–∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –≤–∞—Ä—ñ–∞—Ü—ñ—ó ${stabilityCoef}%) ‚Äî —Ü–µ –æ–∑–Ω–∞–∫–∞ –≤—ñ–¥–º—ñ–Ω–Ω–æ–≥–æ —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—é —Ç–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ –º–µ—Ç—Ä–æ–Ω–æ–º–∞.`;
    } else if (stabilityCoef < 20) {
      rhythmText = `–£ –≤–∞—Å —Ö–æ—Ä–æ—à–∏–π —Ä–∏—Ç–º –∑ –Ω–µ–≤–µ–ª–∏–∫–∏–º–∏ –∫–æ–ª–∏–≤–∞–Ω–Ω—è–º–∏ (–≤–∞—Ä—ñ–∞—Ü—ñ—è ${stabilityCoef}%) ‚Äî —Ü–µ –Ω–æ—Ä–º–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ –∑–¥–æ—Ä–æ–≤–æ—ó –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏.`;
    } else if (stabilityCoef < 30) {
      rhythmText = `–ü–æ–º—ñ—Ä–Ω–∞ –≤–∞—Ä—ñ–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å —Ç–µ–º–ø—É (${stabilityCoef}%) –≤–∫–∞–∑—É—î –Ω–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –≤–∞—à–æ—ó –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ –¥–æ –∑–º—ñ–Ω–Ω–∏—Ö —É–º–æ–≤.`;
    } else {
      rhythmText = `–í–∏—Å–æ–∫–∞ –≤–∞—Ä—ñ–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å —Ç–µ–º–ø—É (${stabilityCoef}%) –º–æ–∂–µ —Å–≤—ñ–¥—á–∏—Ç–∏ –ø—Ä–æ –µ–º–æ—Ü—ñ–π–Ω—ñ—Å—Ç—å –∞–±–æ —Ç–≤–æ—Ä—á–∏–π —Ç–∏–ø –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏, —è–∫–∞ —à–≤–∏–¥–∫–æ —Ä–µ–∞–≥—É—î –Ω–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ —ñ–º–ø—É–ª—å—Å–∏.`;
    }
    
    // Peak performance timing analysis
    if (peakTiming === '–ø–æ—á–∞—Ç–æ–∫') {
      peakText = `–í–∞—à –ø—ñ–∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ø—Ä–∏–ø–∞–¥–∞—î –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ —Ä–æ–±–æ—Ç–∏ ‚Äî –≤–∏ –∑–¥–∞—Ç–Ω—ñ —à–≤–∏–¥–∫–æ –º–æ–±—ñ–ª—ñ–∑—É–≤–∞—Ç–∏—Å—å —ñ –≤–∏–¥–∞–≤–∞—Ç–∏ –º–∞–∫—Å–∏–º—É–º –æ–¥—Ä–∞–∑—É.`;
    } else if (peakTiming === '—Å–µ—Ä–µ–¥–∏–Ω–∞') {
      peakText = `–ü—ñ–∫ –≤–∞—à–æ—ó –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –≤ —Å–µ—Ä–µ–¥–∏–Ω—ñ —Ç–µ—Å—Ç—É ‚Äî —Ü–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–ø–æ–¥—ñ–ª —Å–∏–ª, –∫–æ–ª–∏ –≤–∏ –≤–∂–µ —Ä–æ–∑—ñ–≥—Ä—ñ–ª–∏—Å—å, –∞–ª–µ —â–µ –Ω–µ –≤—Ç–æ–º–∏–ª–∏—Å—å.`;
    } else {
      peakText = `–¶—ñ–∫–∞–≤–æ, —â–æ –≤–∞—à –ø—ñ–∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –Ω–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ —Ç–µ—Å—Ç—É ‚Äî –º–æ–∂–ª–∏–≤–æ, –≤–∏ –≤—ñ–¥—á—É–ª–∏ –Ω–∞–±–ª–∏–∂–µ–Ω–Ω—è —Ñ—ñ–Ω—ñ—à—É —ñ –º–æ–±—ñ–ª—ñ–∑—É–≤–∞–ª–∏ —Ä–µ–∑–µ—Ä–≤–∏.`;
    }
    
    // Recovery ability
    if (hasRecovery) {
      recoveryText = `–ü–æ–º—ñ—á–µ–Ω–∞ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å –¥–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–º–ø—É –ø—ñ—Å–ª—è —Å–ø–∞–¥—É ‚Äî —Ü–µ –æ–∑–Ω–∞–∫–∞ –≥–Ω—É—á–∫–æ—Å—Ç—ñ —Ç–∞ —Ä–µ–∑–µ—Ä–≤—ñ–≤ –≤–∞—à–æ—ó –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏.`;
    } else if (variation < avgTaps * 0.1) {
      recoveryText = `–°—Ç–∞–±—ñ–ª—å–Ω–∏–π —Ç–µ–º–ø –±–µ–∑ –∑–Ω–∞—á–Ω–∏—Ö —Å–ø–∞–¥—ñ–≤ –ø–æ–∫–∞–∑—É—î —Ö–æ—Ä–æ—à—É –≤–∏—Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –±–µ–∑ –ø–æ—Ç—Ä–µ–±–∏ –≤ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—ñ –ø—Ä–æ—Ç—è–≥–æ–º –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Ç–µ—Å—Ç—É.`;
    } else {
      recoveryText = `–õ—ñ–Ω—ñ–π–Ω–∞ –¥–∏–Ω–∞–º—ñ–∫–∞ –±–µ–∑ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–º–ø—É ‚Äî —Ç–∏–ø–æ–≤–∏–π –ø–∞—Ç–µ—Ä–Ω –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Ç–µ—Å—Ç—É, –¥–µ –æ—Ä–≥–∞–Ω—ñ–∑–º –ø—Ä–∞—Ü—é—î –Ω–∞ –æ–¥–Ω–æ–º—É –¥–∏—Ö–∞–Ω–Ω—ñ.`;
    }
    
    // Additional insights based on specific patterns
    let additionalInsights = '';
    
    // Check for warm-up effect
    if (counts[1] > counts[0] * 1.1) {
      additionalInsights += `<p><strong>üî• –ï—Ñ–µ–∫—Ç —Ä–æ–∑—ñ–≥—Ä—ñ–≤—É:</strong> –ü–æ–º—ñ—Ç–Ω–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –≤ –¥—Ä—É–≥–æ–º—É —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ (+${((counts[1] - counts[0]) / counts[0] * 100).toFixed(0)}%) ‚Äî –≤–∞—à—ñ–π –Ω–µ—Ä–≤–æ–≤—ñ–π —Å–∏—Å—Ç–µ–º—ñ –ø–æ—Ç—Ä—ñ–±–µ–Ω —á–∞—Å –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–Ω—è.</p>`;
    }
    
    // Check for final sprint
    if (lastInterval > counts[counts.length - 2] * 1.1) {
      additionalInsights += `<p><strong>üèÉ –§—ñ–Ω—ñ—à–Ω–∏–π —Ä–∏–≤–æ–∫:</strong> –ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è –≤ –æ—Å—Ç–∞–Ω–Ω—å–æ–º—É —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ (+${((lastInterval - counts[counts.length - 2]) / counts[counts.length - 2] * 100).toFixed(0)}%) ‚Äî –≤–∏ –≤–º—ñ—î—Ç–µ –º–æ–±—ñ–ª—ñ–∑—É–≤–∞—Ç–∏ —Ä–µ–∑–µ—Ä–≤–∏ –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è–º.</p>`;
    }
    
    // Check for consistency in middle
    const middleVariation = Math.max(...counts.slice(1, -1)) - Math.min(...counts.slice(1, -1));
    if (middleVariation < avgTaps * 0.1) {
      additionalInsights += `<p><strong>‚öñÔ∏è –°—Ç–∞–±—ñ–ª—å–Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–∞:</strong> –°–µ—Ä–µ–¥–Ω—ñ —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∏ –º–∞–π–∂–µ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ (—Ä—ñ–∑–Ω–∏—Ü—è ${middleVariation} —Ç–∞–ø—ñ–≤) ‚Äî –æ–∑–Ω–∞–∫–∞ –≤—ñ–¥–º—ñ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—é —Ç–µ–º–ø—É.</p>`;
    }
    
    // Neurotype suggestion
    let neurotype = '';
    if (total > 240 && stabilityCoef < 15) {
      neurotype = `<p><strong>üß¨ –ù–µ–π—Ä–æ—Ç–∏–ø:</strong> –°–∏–ª—å–Ω–∏–π –≤—Ä—ñ–≤–Ω–æ–≤–∞–∂–µ–Ω–∏–π —Ä—É—Ö–ª–∏–≤–∏–π —Ç–∏–ø –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ ‚Äî –ø–æ—î–¥–Ω–∞–Ω–Ω—è –≤–∏—Å–æ–∫–æ—ó —à–≤–∏–¥–∫–æ—Å—Ç—ñ —Ç–∞ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ.</p>`;
    } else if (total > 240 && stabilityCoef > 25) {
      neurotype = `<p><strong>üß¨ –ù–µ–π—Ä–æ—Ç–∏–ø:</strong> –°–∏–ª—å–Ω–∏–π –Ω–µ–≤—Ä—ñ–≤–Ω–æ–≤–∞–∂–µ–Ω–∏–π —Ç–∏–ø ‚Äî –≤–∏—Å–æ–∫–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å –∑ –µ–ª–µ–º–µ–Ω—Ç–∞–º–∏ —ñ–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç—ñ.</p>`;
    } else if (total < 180 && stabilityCoef < 15) {
      neurotype = `<p><strong>üß¨ –ù–µ–π—Ä–æ—Ç–∏–ø:</strong> –í—Ä—ñ–≤–Ω–æ–≤–∞–∂–µ–Ω–∏–π —ñ–Ω–µ—Ä—Ç–Ω–∏–π —Ç–∏–ø ‚Äî —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å –≤–∞–∂–ª–∏–≤—ñ—à–∞ –∑–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å, –Ω–∞–¥—ñ–π–Ω—ñ—Å—Ç—å —É –º–æ–Ω–æ—Ç–æ–Ω–Ω—ñ–π —Ä–æ–±–æ—Ç—ñ.</p>`;
    } else if (fatigueIdx > 20) {
      neurotype = `<p><strong>üß¨ –ù–µ–π—Ä–æ—Ç–∏–ø:</strong> –°–ª–∞–±–∫–∏–π —Ç–∏–ø –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ ‚Äî —à–≤–∏–¥–∫–∞ –º–æ–±—ñ–ª—ñ–∑–∞—Ü—ñ—è, –∞–ª–µ –π —à–≤–∏–¥–∫–µ –≤–∏—Å–Ω–∞–∂–µ–Ω–Ω—è. –ü–æ—Ç—Ä–µ–±—É—î —á–∞—Å—Ç–∏—Ö –ø–µ—Ä–µ—Ä–≤ –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è.</p>`;
    }
    
    // Generate HTML content with extended analysis
    const feedbackHTML = `
      <div class="feedback-metric">
        <strong>${total}</strong>
        <span class="label">–∑–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞—Ç–∏—Å–∫–∞–Ω—å</span>
      </div>
      
      <div class="feedback-metric">
        <strong>${profileType} —Ç–∏–ø</strong>
        <span class="label">–≤–∞—à –ø—Å–∏—Ö–æ–º–æ—Ç–æ—Ä–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å</span>
      </div>
      
      <div class="feedback-interpretation">
        <p><strong>üìä –°—Ç—Ä–∞—Ç–µ–≥—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:</strong> ${strategyText}</p>
        <p><strong>üéØ –£–≤–∞–≥–∞ —ñ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—è:</strong> ${attentionText}</p>
        <p><strong>üí™ –í–∏—Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:</strong> ${enduranceText}</p>
        <p><strong>üéµ –†–∏—Ç–º—ñ—á–Ω—ñ—Å—Ç—å:</strong> ${rhythmText}</p>
        <p><strong>‚ö° –ü—ñ–∫–æ–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å:</strong> ${peakText}</p>
        <p><strong>üîÑ –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è:</strong> ${recoveryText}</p>
        <p><strong>üìà –Ü–Ω–¥–µ–∫—Å —Å—Ç–æ–º–ª—é–≤–∞–Ω–æ—Å—Ç—ñ (${(fatigueIdx >= 0 ? '+' : '')}${fatigueIdx.toFixed(1)}%):</strong> ${
          fatigueIdx < -5 ? '–í–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –Ω–∞–±–∏—Ä–∞—î —Ç–µ–º–ø –ø—ñ–¥ —á–∞—Å —Ä–æ–±–æ—Ç–∏ ‚Äî —Ü–µ –æ–∑–Ω–∞–∫–∞ —Ö–æ—Ä–æ—à–æ—ó –∞–¥–∞–ø—Ç–∞—Ü—ñ—ó –¥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.' :
          fatigueIdx > 10 ? '–ü–æ–º—ñ—Ç–Ω–µ –∑–Ω–∏–∂–µ–Ω–Ω—è —Ç–µ–º–ø—É –Ω–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ ‚Äî –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ —à–≤–∏–¥–∫–æ –≤–∏—Ç—Ä–∞—á–∞—î —Ä–µ—Å—É—Ä—Å–∏, –∞–ª–µ —Ü–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—ó —Ä–æ–±–æ—Ç–∏.' :
          '–ù–µ–≤–∏—Å–æ–∫–∏–π —ñ–Ω–¥–µ–∫—Å —Å—Ç–æ–º–ª—é–≤–∞–Ω–æ—Å—Ç—ñ ‚Äî –≤–∏ –¥–æ–±—Ä–µ –≤–∏—Ç—Ä–∏–º—É—î—Ç–µ –∫–æ—Ä–æ—Ç–∫–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –∑–±–µ—Ä—ñ–≥–∞—î—Ç–µ –ø—Ä–∞—Ü–µ–∑–¥–∞—Ç–Ω—ñ—Å—Ç—å.'
        }</p>
        ${additionalInsights}
        ${neurotype}
      </div>
      
      <div class="feedback-note">
        üí° –¢–µ–ø—ñ–Ω–≥-—Ç–µ—Å—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π —Å—Ç–∏–ª—å —Ä–æ–±–æ—Ç–∏ –≤–∞—à–æ—ó –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏. –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –º–æ–∂—É—Ç—å –∑–º—ñ–Ω—é–≤–∞—Ç–∏—Å—å –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å–Ω—É, —Å—Ç—Ä–µ—Å—É, –Ω–∞—Å—Ç—Ä–æ—é —á–∏ —Ñ—ñ–∑–∏—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É. –ö–æ–∂–µ–Ω –ø—Ä–æ—Ñ—ñ–ª—å –º–∞—î —Å–≤–æ—ó –ø–µ—Ä–µ–≤–∞–≥–∏ ‚Äî –≤–∞–∂–ª–∏–≤–æ –∑–Ω–∞—Ç–∏ —Å–≤–æ—ó –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ó—Ö –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ.
      </div>
    `;
    
    feedbackContent.innerHTML = feedbackHTML;
    feedbackCard.style.display = 'block';
    
    // Scroll to feedback after a short delay
    setTimeout(() => {
      feedbackCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
  }
  
  // Hide feedback when starting new test
  function hideFeedback() {
    const feedbackCard = document.getElementById('feedbackCard');
    feedbackCard.style.display = 'none';
  }

  // Show latest result feedback
  function showLatestResult() {
    const KEY='tapping_runs_iljin_v1';
    const runs = JSON.parse(localStorage.getItem(KEY) || '[]');
    if (runs.length === 0) {
      alert('–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.');
      return;
    }
    
    const latestRun = runs[runs.length - 1];
    const counts = latestRun.counts || [];
    const total = latestRun.total || 0;
    const fatigueIdx = latestRun.F || 0;
    
    if (total === 0) {
      alert('–û—Å—Ç–∞–Ω–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Ä–æ–∂–Ω—ñ–π.');
      return;
    }
    
    // Generate and show feedback for latest result
    generatePsychologicalFeedback(counts, total, fatigueIdx);
  }

  function generatePsychologicalFeedback(counts, total, fatigueIdx) {
    const feedbackCard = document.getElementById('feedbackCard');
    const feedbackContent = document.getElementById('feedbackContent');
    
    // Calculate extended metrics for deeper analysis
    const firstHalf = counts.slice(0, 3).reduce((a, b) => a + b, 0);
    const secondHalf = counts.slice(3).reduce((a, b) => a + b, 0);
    const avgTaps = total / counts.length;
    const maxTaps = Math.max(...counts);
    const minTaps = Math.min(...counts);
    const variation = maxTaps - minTaps;
    const variationPercent = (variation / avgTaps * 100).toFixed(0);
    
    // New metrics for deeper analysis
    const firstInterval = counts[0];
    const lastInterval = counts[counts.length - 1];
    const middleIntervals = counts.slice(1, -1).reduce((a, b) => a + b, 0) / (counts.length - 2);
    
    // Calculate tempo stability (standard deviation)
    const mean = total / counts.length;
    const variance = counts.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / counts.length;
    const stdDev = Math.sqrt(variance);
    const stabilityCoef = (stdDev / mean * 100).toFixed(0);
    
    // Peak performance analysis
    const peakIndex = counts.indexOf(maxTaps);
    const peakTiming = peakIndex < 2 ? '–ø–æ—á–∞—Ç–æ–∫' : peakIndex < 4 ? '—Å–µ—Ä–µ–¥–∏–Ω–∞' : '–∫—ñ–Ω–µ—Ü—å';
    
    // Recovery analysis (if there's a dip and recovery)
    let hasRecovery = false;
    for (let i = 1; i < counts.length - 1; i++) {
      if (counts[i] < counts[i-1] && counts[i+1] > counts[i]) {
        hasRecovery = true;
        break;
      }
    }
    
    // Momentum analysis
    const momentum = ((lastInterval - firstInterval) / firstInterval * 100).toFixed(0);
    
    // Determine profile type based on pattern
    let profileType = '';
    let strategyText = '';
    let attentionText = '';
    let enduranceText = '';
    let rhythmText = '';
    let peakText = '';
    let recoveryText = '';
    
    // Profile analysis with extended criteria
    if (fatigueIdx < -10) {
      profileType = '–ü—Ä–æ–≥—Ä–µ—Å–∏–≤–Ω–∏–π';
      strategyText = '–í–∏ —Å—Ç–∞—Ä—Ç—É—î—Ç–µ –æ–±–µ—Ä–µ–∂–Ω–æ, –∞ –ø–æ—Ç—ñ–º ¬´—Ä–æ–∑—ñ–≥—Ä—ñ–≤–∞—î—Ç–µ—Å—å¬ª —ñ –≤—Ö–æ–¥–∏—Ç–µ –≤ —Ä–∏—Ç–º. –¶–µ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è ¬´–º–∞—Ä–∞—Ñ–æ–Ω—Ü—è¬ª ‚Äî –≤–∏ –≤–º—ñ—î—Ç–µ —Ä–æ–∑–ø–æ–¥—ñ–ª—è—Ç–∏ —Å–∏–ª–∏ —Ç–∞ –Ω–∞—Ä–æ—â—É–≤–∞—Ç–∏ —Ç–µ–º–ø –ø–æ—Å—Ç—É–ø–æ–≤–æ.';
      attentionText = '–í–∞—à–∞ —É–≤–∞–≥–∞ –ø–æ–∫—Ä–∞—â—É—î—Ç—å—Å—è –∑ —á–∞—Å–æ–º ‚Äî –≤–∏ –ø–æ—Ç—Ä–µ–±—É—î—Ç–µ —Ç—Ä–æ—Ö–∏ —á–∞—Å—É –¥–ª—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—ó, –∞–ª–µ –ø–æ—Ç—ñ–º –ø–æ–∫–∞–∑—É—î—Ç–µ —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.';
    } else if (fatigueIdx > 15) {
      profileType = '–°–ø—Ä–∏–Ω—Ç–µ—Ä—Å—å–∫–∏–π';
      strategyText = '–í–∏ —Å—Ç–∞—Ä—Ç—É—î—Ç–µ —à–≤–∏–¥–∫–æ –π –ø–æ—Ç—É–∂–Ω–æ, –≤–∏–∫–ª–∞–¥–∞—é—á–∏—Å—å –æ–¥—Ä–∞–∑—É. –¶–µ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è ¬´—Å–ø—Ä–∏–Ω—Ç–µ—Ä–∞¬ª ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –º–æ–±—ñ–ª—ñ–∑–∞—Ü—ñ—è –Ω–∞ –ø–æ—á–∞—Ç–∫—É –∑ –ø—Ä–∏—Ä–æ–¥–Ω–∏–º —Å–ø–∞–¥–æ–º –Ω–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ.';
      attentionText = '–í–∏ —à–≤–∏–¥–∫–æ –≤–∫–ª—é—á–∞—î—Ç–µ—Å—å —É —Ä–æ–±–æ—Ç—É, –∞–ª–µ —É–≤–∞–≥–∞ –≤—Ç–æ–º–ª—é—î—Ç—å—Å—è –Ω–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ. –¶–µ –ø—Ä–∏—Ä–æ–¥–Ω–æ –π —Ç–∏–ø–æ–≤–æ –¥–ª—è –ª—é–¥–µ–π –∑ –≤–∏—Å–æ–∫–æ—é –ø–æ—á–∞—Ç–∫–æ–≤–æ—é –º–æ–±—ñ–ª—ñ–∑–∞—Ü—ñ—î—é.';
    } else if (stabilityCoef < 15) {
      profileType = '–°—Ç–∞–±—ñ–ª—å–Ω–∏–π';
      strategyText = '–í–∞—à —Ç–µ–º–ø –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —Ä—ñ–≤–Ω–∏–º —É–ø—Ä–æ–¥–æ–≤–∂ —É—Å—å–æ–≥–æ —Ç–µ—Å—Ç—É ‚Äî —Ü–µ –æ–∑–Ω–∞–∫–∞ –≤–º—ñ–Ω–Ω—è —Ç—Ä–∏–º–∞—Ç–∏ –±–∞–ª–∞–Ω—Å —ñ —Ä–æ–∑–ø–æ–¥—ñ–ª—è—Ç–∏ —Å–∏–ª–∏. –í–∏ –¥–æ–±—Ä–µ –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç–µ —Å–≤—ñ–π —Ä–∏—Ç–º.';
      attentionText = '–í–∞—à–∞ —É–≤–∞–≥–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—é –ø—Ä–æ—Ç—è–≥–æ–º —É—Å—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è. –í–∏ –∑–¥–∞—Ç–Ω—ñ —É—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—é —Ç–∞ –Ω–µ –ø—ñ–¥–¥–∞–≤–∞—Ç–∏—Å—å –≤—Ç–æ–º—ñ üßò.';
    } else {
      profileType = '–ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π';
      strategyText = '–í–∞—à —Ç–µ–º–ø –∑–º—ñ–Ω—é—î—Ç—å—Å—è –ø—Ä–æ—Ç—è–≥–æ–º —Ç–µ—Å—Ç—É ‚Äî –≤–∏ –∞–¥–∞–ø—Ç—É—î—Ç–µ—Å—å –¥–æ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞ —à—É–∫–∞—î—Ç–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏–π —Ä–∏—Ç–º. –¶–µ –≥–Ω—É—á–∫–∏–π –ø—ñ–¥—Ö—ñ–¥ –¥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.';
      attentionText = '–í–∞—à–∞ —É–≤–∞–≥–∞ –º–∞—î —Ö–≤–∏–ª—å–æ–≤–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä ‚Äî –ø–µ—Ä—ñ–æ–¥–∏ –≤–∏—Å–æ–∫–æ—ó –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—ó —á–µ—Ä–≥—É—é—Ç—å—Å—è –∑ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Å–ø–∞–¥–∞–º–∏. –¶–µ –Ω–æ—Ä–º–∞–ª—å–Ω–∞ –¥–∏–Ω–∞–º—ñ–∫–∞ —Ä–æ–±–æ—Ç–∏ –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏.';
    }
    
    // Endurance analysis with more detail
    if (total > 250) {
      enduranceText = `–í–∏—Å–æ–∫–∏–π –∑–∞–≥–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (${total} –Ω–∞—Ç–∏—Å–∫–∞–Ω—å) —Å–≤—ñ–¥—á–∏—Ç—å –ø—Ä–æ –≤—ñ–¥–º—ñ–Ω–Ω—É –ø—Å–∏—Ö–æ–º–æ—Ç–æ—Ä–Ω—É –≤–∏—Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Ç–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å —Ä–µ–∞–∫—Ü—ñ—ó. –í–∞—à–∞ –Ω–µ—Ä–≤–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞—Ü—é—î –Ω–∞ –≤–∏—Å–æ–∫—ñ–π —á–∞—Å—Ç–æ—Ç—ñ.`;
    } else if (total > 200) {
      enduranceText = `–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (${total} –Ω–∞—Ç–∏—Å–∫–∞–Ω—å) –ø–æ–∫–∞–∑—É—î –∑–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω—É —Ä–æ–±–æ—Ç—É –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ –¥–æ—Å—Ç–∞—Ç–Ω—é –≤–∏—Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å. –í–∏ –º–∞—î—Ç–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å —à–≤–∏–¥–∫–æ—Å—Ç—ñ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é.`;
    } else if (total > 150) {
      enduranceText = `–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç (${total} –Ω–∞—Ç–∏—Å–∫–∞–Ω—å) –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î —Å–ø–æ–∫—ñ–π–Ω–∏–π, —Ä–æ–∑–º—ñ—Ä–µ–Ω–∏–π —Å—Ç–∏–ª—å —Ä–æ–±–æ—Ç–∏. –í–∏ –Ω–µ –ø–æ—Å–ø—ñ—à–∞—î—Ç–µ, –∞–ª–µ –≤–∏–∫–æ–Ω—É—î—Ç–µ –∑–∞–≤–¥–∞–Ω–Ω—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ —Ç–∞ —É—Å–≤—ñ–¥–æ–º–ª–µ–Ω–æ.`;
    } else {
      enduranceText = `–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç (${total} –Ω–∞—Ç–∏—Å–∫–∞–Ω—å) –º–æ–∂–µ —Å–≤—ñ–¥—á–∏—Ç–∏ –ø—Ä–æ –æ–±–µ—Ä–µ–∂–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –∞–±–æ –≤—Ç–æ–º—É. –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Ç–µ—Å—Ç –ø—ñ—Å–ª—è –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è.`;
    }
    
    // Rhythm analysis
    if (stabilityCoef < 10) {
      rhythmText = `–í–∞—à —Ä–∏—Ç–º –Ω–∞–¥–∑–≤–∏—á–∞–π–Ω–æ —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π (–∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –≤–∞—Ä—ñ–∞—Ü—ñ—ó ${stabilityCoef}%) ‚Äî —Ü–µ –æ–∑–Ω–∞–∫–∞ –≤—ñ–¥–º—ñ–Ω–Ω–æ–≥–æ —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—é —Ç–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ –º–µ—Ç—Ä–æ–Ω–æ–º–∞.`;
    } else if (stabilityCoef < 20) {
      rhythmText = `–£ –≤–∞—Å —Ö–æ—Ä–æ—à–∏–π —Ä–∏—Ç–º –∑ –Ω–µ–≤–µ–ª–∏–∫–∏–º–∏ –∫–æ–ª–∏–≤–∞–Ω–Ω—è–º–∏ (–≤–∞—Ä—ñ–∞—Ü—ñ—è ${stabilityCoef}%) ‚Äî —Ü–µ –Ω–æ—Ä–º–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ –∑–¥–æ—Ä–æ–≤–æ—ó –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏.`;
    } else if (stabilityCoef < 30) {
      rhythmText = `–ü–æ–º—ñ—Ä–Ω–∞ –≤–∞—Ä—ñ–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å —Ç–µ–º–ø—É (${stabilityCoef}%) –≤–∫–∞–∑—É—î –Ω–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –≤–∞—à–æ—ó –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ –¥–æ –∑–º—ñ–Ω–Ω–∏—Ö —É–º–æ–≤.`;
    } else {
      rhythmText = `–í–∏—Å–æ–∫–∞ –≤–∞—Ä—ñ–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å —Ç–µ–º–ø—É (${stabilityCoef}%) –º–æ–∂–µ —Å–≤—ñ–¥—á–∏—Ç–∏ –ø—Ä–æ –µ–º–æ—Ü—ñ–π–Ω—ñ—Å—Ç—å –∞–±–æ —Ç–≤–æ—Ä—á–∏–π —Ç–∏–ø –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏, —è–∫–∞ —à–≤–∏–¥–∫–æ —Ä–µ–∞–≥—É—î –Ω–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ —ñ–º–ø—É–ª—å—Å–∏.`;
    }
    
    // Peak performance timing analysis
    if (peakTiming === '–ø–æ—á–∞—Ç–æ–∫') {
      peakText = `–í–∞—à –ø—ñ–∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ø—Ä–∏–ø–∞–¥–∞—î –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ —Ä–æ–±–æ—Ç–∏ ‚Äî –≤–∏ –∑–¥–∞—Ç–Ω—ñ —à–≤–∏–¥–∫–æ –º–æ–±—ñ–ª—ñ–∑—É–≤–∞—Ç–∏—Å—å —ñ –≤–∏–¥–∞–≤–∞—Ç–∏ –º–∞–∫—Å–∏–º—É–º –æ–¥—Ä–∞–∑—É.`;
    } else if (peakTiming === '—Å–µ—Ä–µ–¥–∏–Ω–∞') {
      peakText = `–ü—ñ–∫ –≤–∞—à–æ—ó –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –≤ —Å–µ—Ä–µ–¥–∏–Ω—ñ —Ç–µ—Å—Ç—É ‚Äî —Ü–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–ø–æ–¥—ñ–ª —Å–∏–ª, –∫–æ–ª–∏ –≤–∏ –≤–∂–µ —Ä–æ–∑—ñ–≥—Ä—ñ–ª–∏—Å—å, –∞–ª–µ —â–µ –Ω–µ –≤—Ç–æ–º–∏–ª–∏—Å—å.`;
    } else {
      peakText = `–¶—ñ–∫–∞–≤–æ, —â–æ –≤–∞—à –ø—ñ–∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –Ω–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ —Ç–µ—Å—Ç—É ‚Äî –º–æ–∂–ª–∏–≤–æ, –≤–∏ –≤—ñ–¥—á—É–ª–∏ –Ω–∞–±–ª–∏–∂–µ–Ω–Ω—è —Ñ—ñ–Ω—ñ—à—É —ñ –º–æ–±—ñ–ª—ñ–∑—É–≤–∞–ª–∏ —Ä–µ–∑–µ—Ä–≤–∏.`;
    }
    
    // Recovery ability
    if (hasRecovery) {
      recoveryText = `–ü–æ–º—ñ—á–µ–Ω–∞ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å –¥–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–º–ø—É –ø—ñ—Å–ª—è —Å–ø–∞–¥—É ‚Äî —Ü–µ –æ–∑–Ω–∞–∫–∞ –≥–Ω—É—á–∫–æ—Å—Ç—ñ —Ç–∞ —Ä–µ–∑–µ—Ä–≤—ñ–≤ –≤–∞—à–æ—ó –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏.`;
    } else if (variation < avgTaps * 0.1) {
      recoveryText = `–°—Ç–∞–±—ñ–ª—å–Ω–∏–π —Ç–µ–º–ø –±–µ–∑ –∑–Ω–∞—á–Ω–∏—Ö —Å–ø–∞–¥—ñ–≤ –ø–æ–∫–∞–∑—É—î —Ö–æ—Ä–æ—à—É –≤–∏—Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –±–µ–∑ –ø–æ—Ç—Ä–µ–±–∏ –≤ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—ñ –ø—Ä–æ—Ç—è–≥–æ–º –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Ç–µ—Å—Ç—É.`;
    } else {
      recoveryText = `–õ—ñ–Ω—ñ–π–Ω–∞ –¥–∏–Ω–∞–º—ñ–∫–∞ –±–µ–∑ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–º–ø—É ‚Äî —Ç–∏–ø–æ–≤–∏–π –ø–∞—Ç–µ—Ä–Ω –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Ç–µ—Å—Ç—É, –¥–µ –æ—Ä–≥–∞–Ω—ñ–∑–º –ø—Ä–∞—Ü—é—î –Ω–∞ –æ–¥–Ω–æ–º—É –¥–∏—Ö–∞–Ω–Ω—ñ.`;
    }
    
    // Additional insights based on specific patterns
    let additionalInsights = '';
    
    // Check for warm-up effect
    if (counts[1] > counts[0] * 1.1) {
      additionalInsights += `<p><strong>üî• –ï—Ñ–µ–∫—Ç —Ä–æ–∑—ñ–≥—Ä—ñ–≤—É:</strong> –ü–æ–º—ñ—Ç–Ω–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –≤ –¥—Ä—É–≥–æ–º—É —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ (+${((counts[1] - counts[0]) / counts[0] * 100).toFixed(0)}%) ‚Äî –≤–∞—à—ñ–π –Ω–µ—Ä–≤–æ–≤—ñ–π —Å–∏—Å—Ç–µ–º—ñ –ø–æ—Ç—Ä—ñ–±–µ–Ω —á–∞—Å –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–Ω—è.</p>`;
    }
    
    // Check for final sprint
    if (lastInterval > counts[counts.length - 2] * 1.1) {
      additionalInsights += `<p><strong>üèÉ –§—ñ–Ω—ñ—à–Ω–∏–π —Ä–∏–≤–æ–∫:</strong> –ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è –≤ –æ—Å—Ç–∞–Ω–Ω—å–æ–º—É —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ (+${((lastInterval - counts[counts.length - 2]) / counts[counts.length - 2] * 100).toFixed(0)}%) ‚Äî –≤–∏ –≤–º—ñ—î—Ç–µ –º–æ–±—ñ–ª—ñ–∑—É–≤–∞—Ç–∏ —Ä–µ–∑–µ—Ä–≤–∏ –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è–º.</p>`;
    }
    
    // Check for consistency in middle
    const middleVariation = Math.max(...counts.slice(1, -1)) - Math.min(...counts.slice(1, -1));
    if (middleVariation < avgTaps * 0.1) {
      additionalInsights += `<p><strong>‚öñÔ∏è –°—Ç–∞–±—ñ–ª—å–Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–∞:</strong> –°–µ—Ä–µ–¥–Ω—ñ —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∏ –º–∞–π–∂–µ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ (—Ä—ñ–∑–Ω–∏—Ü—è ${middleVariation} —Ç–∞–ø—ñ–≤) ‚Äî –æ–∑–Ω–∞–∫–∞ –≤—ñ–¥–º—ñ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—é —Ç–µ–º–ø—É.</p>`;
    }
    
    // Neurotype suggestion
    let neurotype = '';
    if (total > 240 && stabilityCoef < 15) {
      neurotype = `<p><strong>üß¨ –ù–µ–π—Ä–æ—Ç–∏–ø:</strong> –°–∏–ª—å–Ω–∏–π –≤—Ä—ñ–≤–Ω–æ–≤–∞–∂–µ–Ω–∏–π —Ä—É—Ö–ª–∏–≤–∏–π —Ç–∏–ø –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ ‚Äî –ø–æ—î–¥–Ω–∞–Ω–Ω—è –≤–∏—Å–æ–∫–æ—ó —à–≤–∏–¥–∫–æ—Å—Ç—ñ —Ç–∞ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ.</p>`;
    } else if (total > 240 && stabilityCoef > 25) {
      neurotype = `<p><strong>üß¨ –ù–µ–π—Ä–æ—Ç–∏–ø:</strong> –°–∏–ª—å–Ω–∏–π –Ω–µ–≤—Ä—ñ–≤–Ω–æ–≤–∞–∂–µ–Ω–∏–π —Ç–∏–ø ‚Äî –≤–∏—Å–æ–∫–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å –∑ –µ–ª–µ–º–µ–Ω—Ç–∞–º–∏ —ñ–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç—ñ.</p>`;
    } else if (total < 180 && stabilityCoef < 15) {
      neurotype = `<p><strong>üß¨ –ù–µ–π—Ä–æ—Ç–∏–ø:</strong> –í—Ä—ñ–≤–Ω–æ–≤–∞–∂–µ–Ω–∏–π —ñ–Ω–µ—Ä—Ç–Ω–∏–π —Ç–∏–ø ‚Äî —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å –≤–∞–∂–ª–∏–≤—ñ—à–∞ –∑–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å, –Ω–∞–¥—ñ–π–Ω—ñ—Å—Ç—å —É –º–æ–Ω–æ—Ç–æ–Ω–Ω—ñ–π —Ä–æ–±–æ—Ç—ñ.</p>`;
    } else if (fatigueIdx > 20) {
      neurotype = `<p><strong>üß¨ –ù–µ–π—Ä–æ—Ç–∏–ø:</strong> –°–ª–∞–±–∫–∏–π —Ç–∏–ø –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ ‚Äî —à–≤–∏–¥–∫–∞ –º–æ–±—ñ–ª—ñ–∑–∞—Ü—ñ—è, –∞–ª–µ –π —à–≤–∏–¥–∫–µ –≤–∏—Å–Ω–∞–∂–µ–Ω–Ω—è. –ü–æ—Ç—Ä–µ–±—É—î —á–∞—Å—Ç–∏—Ö –ø–µ—Ä–µ—Ä–≤ –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è.</p>`;
    }
    
    // Generate HTML content with extended analysis
    const feedbackHTML = `
      <div class="feedback-metric">
        <strong>${total}</strong>
        <span class="label">–∑–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞—Ç–∏—Å–∫–∞–Ω—å</span>
      </div>
      
      <div class="feedback-metric">
        <strong>${profileType} —Ç–∏–ø</strong>
        <span class="label">–≤–∞—à –ø—Å–∏—Ö–æ–º–æ—Ç–æ—Ä–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å</span>
      </div>
      
      <div class="feedback-interpretation">
        <p><strong>üìä –°—Ç—Ä–∞—Ç–µ–≥—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:</strong> ${strategyText}</p>
        <p><strong>üéØ –£–≤–∞–≥–∞ —ñ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—è:</strong> ${attentionText}</p>
        <p><strong>üí™ –í–∏—Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:</strong> ${enduranceText}</p>
        <p><strong>üéµ –†–∏—Ç–º—ñ—á–Ω—ñ—Å—Ç—å:</strong> ${rhythmText}</p>
        <p><strong>‚ö° –ü—ñ–∫–æ–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å:</strong> ${peakText}</p>
        <p><strong>üîÑ –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è:</strong> ${recoveryText}</p>
        <p><strong>üìà –Ü–Ω–¥–µ–∫—Å —Å—Ç–æ–º–ª—é–≤–∞–Ω–æ—Å—Ç—ñ (${(fatigueIdx >= 0 ? '+' : '')}${fatigueIdx.toFixed(1)}%):</strong> ${
          fatigueIdx < -5 ? '–í–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –Ω–∞–±–∏—Ä–∞—î —Ç–µ–º–ø –ø—ñ–¥ —á–∞—Å —Ä–æ–±–æ—Ç–∏ ‚Äî —Ü–µ –æ–∑–Ω–∞–∫–∞ —Ö–æ—Ä–æ—à–æ—ó –∞–¥–∞–ø—Ç–∞—Ü—ñ—ó –¥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.' :
          fatigueIdx > 10 ? '–ü–æ–º—ñ—Ç–Ω–µ –∑–Ω–∏–∂–µ–Ω–Ω—è —Ç–µ–º–ø—É –Ω–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ ‚Äî –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ —à–≤–∏–¥–∫–æ –≤–∏—Ç—Ä–∞—á–∞—î —Ä–µ—Å—É—Ä—Å–∏, –∞–ª–µ —Ü–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—ó —Ä–æ–±–æ—Ç–∏.' :
          '–ù–µ–≤–∏—Å–æ–∫–∏–π —ñ–Ω–¥–µ–∫—Å —Å—Ç–æ–º–ª—é–≤–∞–Ω–æ—Å—Ç—ñ ‚Äî –≤–∏ –¥–æ–±—Ä–µ –≤–∏—Ç—Ä–∏–º—É—î—Ç–µ –∫–æ—Ä–æ—Ç–∫–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –∑–±–µ—Ä—ñ–≥–∞—î—Ç–µ –ø—Ä–∞—Ü–µ–∑–¥–∞—Ç–Ω—ñ—Å—Ç—å.'
        }</p>
        ${additionalInsights}
        ${neurotype}
      </div>
      
      <div class="feedback-note">
        üí° –¢–µ–ø—ñ–Ω–≥-—Ç–µ—Å—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π —Å—Ç–∏–ª—å —Ä–æ–±–æ—Ç–∏ –≤–∞—à–æ—ó –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏. –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –º–æ–∂—É—Ç—å –∑–º—ñ–Ω—é–≤–∞—Ç–∏—Å—å –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å–Ω—É, —Å—Ç—Ä–µ—Å—É, –Ω–∞—Å—Ç—Ä–æ—é —á–∏ —Ñ—ñ–∑–∏—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É. –ö–æ–∂–µ–Ω –ø—Ä–æ—Ñ—ñ–ª—å –º–∞—î —Å–≤–æ—ó –ø–µ—Ä–µ–≤–∞–≥–∏ ‚Äî –≤–∞–∂–ª–∏–≤–æ –∑–Ω–∞—Ç–∏ —Å–≤–æ—ó –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ó—Ö –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ.
      </div>
    `;
    
    feedbackContent.innerHTML = feedbackHTML;
    feedbackCard.style.display = 'block';
    
    // Scroll to feedback after a short delay
    setTimeout(() => {
      feedbackCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
  }
  
  // Hide feedback when starting new test
  function hideFeedback() {
    const feedbackCard = document.getElementById('feedbackCard');
    feedbackCard.style.display = 'none';
  }
  
  function showAutoSaveFeedback() {
    // Create temporary feedback element
    const feedback = document.createElement('div');
    feedback.textContent = '–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ ‚úì';
    feedback.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 3000;
      background: #dcfce7; color: #166534; padding: 12px 20px;
      border-radius: 10px; font-size: 0.9rem; font-weight: 600;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      animation: slideInRight 0.3s ease-out;
    `;
    
    // Add animation keyframes if not already added
    if (!document.querySelector('#autoSaveStyles')) {
      const style = document.createElement('style');
      style.id = 'autoSaveStyles';
      style.textContent = `
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    }
    
    document.body.appendChild(feedback);
    
    // Remove feedback after 3 seconds
    setTimeout(() => {
      feedback.style.animation = 'slideOutRight 0.3s ease-in';
      setTimeout(() => feedback.remove(), 300);
    }, 3000);
  }
  
  // Copy ID to clipboard
  async function copyIdToClipboard() {
    const copyBtn = document.getElementById('copyBtn');
    try {
      await navigator.clipboard.writeText(pidEl.value);
      copyBtn.textContent = 'copied';
      copyBtn.classList.add('copied');
      setTimeout(() => {
        copyBtn.textContent = 'copy';
        copyBtn.classList.remove('copied');
      }, 1500);
    } catch (err) {
      // Fallback for browsers that don't support clipboard API
      pidEl.select();
      document.execCommand('copy');
      copyBtn.textContent = 'copied';
      copyBtn.classList.add('copied');
      setTimeout(() => {
        copyBtn.textContent = 'copy';
        copyBtn.classList.remove('copied');
      }, 1500);
    }
  }
  const timerEl=document.getElementById('timer'), totalEl=document.getElementById('total'), intervalsEl=document.getElementById('intervals'), fatigueEl=document.getElementById('fatigue');
  const startBtn=document.getElementById('startBtn');
  const copyLatestBtn=document.getElementById('copyLatestBtn'), showLatestBtn=document.getElementById('showLatestBtn'), exportBtn=document.getElementById('exportBtn'), clearBtn=document.getElementById('clearBtn');
  const grid=document.getElementById('grid'), runsBody=document.getElementById('runsBody');
  let started=false, startAt=0, timerId=null, switchId=null, activeIdx=-1;
  let counts=Array.from({length:N},()=>0), tapsTimestamps=[];

  function fmtSec(s){return s.toFixed(1)+' —Å';}
  function setActiveCell(idx){activeIdx=idx;Array.from(grid.children).forEach((c,i)=>c.classList.toggle('active',i===idx));}
  function resetUI(){started=false;clearInterval(timerId);clearInterval(switchId);counts=Array.from({length:N},()=>0);tapsTimestamps=[];activeIdx=-1;
    Array.from(grid.children).forEach((c,i)=>{c.classList.remove('active');c.querySelector('.cnt').textContent='0';});
    timerEl.textContent=fmtSec(TOTAL_S);totalEl.textContent='0';intervalsEl.textContent='‚Äî –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö ‚Äî';fatigueEl.textContent='‚Äî';
    document.getElementById('countdownOverlay').style.display='none';exitMobileTestMode();startBtn.textContent='–°—Ç–∞—Ä—Ç';startBtn.disabled=false;copyLatestBtn.disabled=true;clearCurrentState();}
  function fatigueIndex(cnt){const f=cnt[0]||0,l=cnt[cnt.length-1]||0;return f?((l-f)/f*100):0;}
  function renderIntervals(){intervalsEl.textContent=counts.map((c,i)=>`${i*STEP_S}-${(i+1)*STEP_S} —Å: ${c}`).join(' | ');
    const F=fatigueIndex(counts);fatigueEl.textContent=(F>=0?'+':'')+F.toFixed(1)+' %';}
  function bump(i){counts[i]++;totalEl.textContent=counts.reduce((a,b)=>a+b,0);document.getElementById('c'+ORDER[i]).textContent=counts[i];renderIntervals();saveCurrentState();}
  function onTap(e){if(!started)return;const idx=+this.dataset.idx;if(idx!==activeIdx)return;
    e.preventDefault();const now=performance.now(),t=(now-startAt)/1000,i=Math.min(Math.floor(t/STEP_S),N-1);if(t>TOTAL_S)return;bump(i);tapsTimestamps.push(+t.toFixed(3));}
  Array.from(grid.children).forEach(c=>{c.addEventListener('touchstart',onTap,{passive:false});c.addEventListener('mousedown',onTap);});
  function updateTimer(){const now=performance.now(),el=(now-startAt)/1000,r=Math.max(0,TOTAL_S-el);timerEl.textContent=fmtSec(r);if(r<=0)stop();}
  function startTest() {
    resetUI();hideFeedback();started=true;startAt=performance.now();
    startBtn.textContent='–°—Ç–æ–ø';copyLatestBtn.disabled=true;setActiveCell(ORDER[0]);saveCurrentState();
    enterMobileTestMode();timerId=setInterval(()=>{updateTimer();updateMobileTimer();},50);let step=0;
    switchId=setInterval(()=>{step++;if(step>=N){stop();return;}setActiveCell(ORDER[step]);saveCurrentState();},STEP_S*1000);
  }
  
  function start(){if(started)return;showCountdown(startTest);}
  function stop(){if(!started)return;started=false;clearInterval(timerId);clearInterval(switchId);updateTimer();setActiveCell(-1);
    document.getElementById('countdownOverlay').style.display='none';exitMobileTestMode();const total=counts.reduce((a,b)=>a+b,0);
    if(total>0){autoSave();copyLatestBtn.disabled=false;}else{copyLatestBtn.disabled=true;}
    startBtn.textContent='–°—Ç–∞—Ä—Ç';}
  function saveRun(){const total=counts.reduce((a,b)=>a+b,0);if(total===0){alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö');return;}
    const run={pid:pidEl.value.trim(),hand:handEl.value,trial:+trialEl.value,duration:TOTAL_S,step:STEP_S,counts:counts.slice(),total,F:+fatigueIndex(counts).toFixed(1),
      times:tapsTimestamps.slice(),device:navigator.userAgent,ts:new Date().toISOString()};
    const KEY='tapping_runs_iljin_v1';const arr=JSON.parse(localStorage.getItem(KEY)||'[]');arr.push(run);localStorage.setItem(KEY,JSON.stringify(arr));renderRuns();saveBtn.disabled=true;startBtn.textContent='–°—Ç–∞—Ä—Ç';clearCurrentState();}
  function renderRuns(){const arr=JSON.parse(localStorage.getItem('tapping_runs_iljin_v1')||'[]');if(!arr.length){runsBody.innerHTML='<tr><td colspan="8" class="small muted">–©–µ –Ω–µ–º–∞—î</td></tr>';return;}
    runsBody.innerHTML=arr.slice(-12).reverse().map((r,displayIndex)=>{
      const actualIndex = arr.length - 1 - displayIndex;
      return `<tr>
        <td>${r.pid||'‚Äî'}</td>
        <td>${r.hand}</td>
        <td>${r.trial}</td>
        <td>${r.total}</td>
        <td class="mono intervals-col">${r.counts.join(', ')}</td>
        <td>${(r.F>=0?'+':'')}${r.F}%</td>
        <td><span class="small muted">${new Date(r.ts).toLocaleString()}</span></td>
        <td><button class="delete-btn" data-index="${actualIndex}" title="–í–∏–¥–∞–ª–∏—Ç–∏">√ó</button></td>
      </tr>`;
    }).join('');}
  function exportCSV(){const arr=JSON.parse(localStorage.getItem('tapping_runs_iljin_v1')||'[]');if(!arr.length){alert('–ù–µ–º–∞—î —Å–ø—Ä–æ–±');return;}
    const m=Math.max(...arr.map(r=>r.counts.length)),header=['pid','hand','trial','duration_s','step_s','total','F_percent','ts','device',...Array.from({length:m},(_,i)=>`count_${i+1}`)];
    const rows=arr.map(r=>{const base=[r.pid,r.hand,r.trial,r.duration,r.step,r.total,r.F,r.ts,JSON.stringify(r.device)],cnt=r.counts.slice();while(cnt.length<m)cnt.push('');return base.concat(cnt);});
    const csv=[header].concat(rows).map(row=>row.map(c=>{const s=String(c??'');return(/["\n]/.test(s))?`"${s.replace(/"/g,'""')}"`:s;}).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download='tapping_iljin.csv';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}
  function clearAll(){if(!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ?'))return;localStorage.removeItem('tapping_runs_iljin_v1');renderRuns();copyLatestBtn.disabled=true;showLatestBtn.disabled=true;}
  function toggleStartStop(){if(started){stop();}else{start();}}
  startBtn.addEventListener('click',toggleStartStop);
  document.getElementById('copyBtn').addEventListener('click',copyIdToClipboard);
  document.getElementById('mobileStopBtn').addEventListener('click', function() {
    stop();
  });
  copyLatestBtn.addEventListener('click',copyLatestResult);showLatestBtn.addEventListener('click',showLatestResult);exportBtn.addEventListener('click',exportCSV);clearBtn.addEventListener('click',clearAll);
  
  // Initialize user ID on page load
  pidEl.value = loadOrGenerateUserId();
  
  // Load previous state if available, otherwise reset UI
  if (!loadPreviousState()) {
    resetUI();
  }
  renderRuns();
  
  // Enable copy and show buttons if there are saved results
  const arr = JSON.parse(localStorage.getItem('tapping_runs_iljin_v1') || '[]');
  if (arr.length > 0) {
    copyLatestBtn.disabled = false;
    showLatestBtn.disabled = false;
  }
  
  // Event delegation for delete buttons
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('delete-btn')) {
      const index = parseInt(e.target.dataset.index);
      deleteResult(index);
    }
  });
})();

// Global delete function
function deleteResult(index) {
  if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç?')) return;
  
  const KEY = 'tapping_runs_iljin_v1';
  const arr = JSON.parse(localStorage.getItem(KEY) || '[]');
  
  if (index >= 0 && index < arr.length) {
    arr.splice(index, 1);
    localStorage.setItem(KEY, JSON.stringify(arr));
    
    // Re-render the table
    const runsBody = document.getElementById('runsBody');
    if (!arr.length) {
      runsBody.innerHTML = '<tr><td colspan="8" class="small muted">–©–µ –Ω–µ–º–∞—î</td></tr>';
    } else {
      runsBody.innerHTML = arr.slice(-12).reverse().map((r, displayIndex) => {
        const actualIndex = arr.length - 1 - displayIndex;
        return `<tr>
          <td>${r.pid || '‚Äî'}</td>
          <td>${r.hand}</td>
          <td>${r.trial}</td>
          <td>${r.total}</td>
          <td class="mono intervals-col">${r.counts.join(', ')}</td>
          <td>${(r.F >= 0 ? '+' : '')}${r.F}%</td>
          <td><span class="small muted">${new Date(r.ts).toLocaleString()}</span></td>
          <td><button class="delete-btn" data-index="${actualIndex}" title="–í–∏–¥–∞–ª–∏—Ç–∏">√ó</button></td>
        </tr>`;
      }).join('');
    }
    
    // Update buttons state
    const copyLatestBtn = document.getElementById('copyLatestBtn');
    const showLatestBtn = document.getElementById('showLatestBtn');
    if (arr.length === 0) {
      copyLatestBtn.disabled = true;
      showLatestBtn.disabled = true;
    }
    
    // Show feedback
    const feedback = document.createElement('div');
    feedback.textContent = '–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–¥–∞–ª–µ–Ω–æ ‚úì';
    feedback.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 3000;
      background: #fef2f2; color: #dc2626; padding: 12px 20px;
      border-radius: 10px; font-size: 0.9rem; font-weight: 600;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      animation: slideInRight 0.3s ease-out;
    `;
    
    document.body.appendChild(feedback);
    setTimeout(() => {
      feedback.style.animation = 'slideOutRight 0.3s ease-in';
      setTimeout(() => feedback.remove(), 300);
    }, 2500);
  }
}
</script>
</body>
</html>
